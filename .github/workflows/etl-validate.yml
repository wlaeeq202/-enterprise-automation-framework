name: ETL Validate (Snowflake-style)

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  etl-validate:
    name: Generate -> Transform -> Validate (+ runtime)
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Step 3: Install dependencies deterministically
      - name: Install dependencies
        run: npm ci

      # Step 4–6: Run ETL end-to-end and measure runtime
      - name: Run ETL + measure runtime
        id: etl_runtime
        shell: bash
        env:
          ROWS: "5000" # CI-safe representative dataset
        run: |
          set -e

          START=$(date +%s)

          npm run etl:generate
          npm run etl:transform
          npm run etl:validate

          END=$(date +%s)
          DURATION=$((END - START))

          echo "duration=$DURATION" >> "$GITHUB_OUTPUT"
          echo "ETL runtime: ${DURATION}s" >> "$GITHUB_STEP_SUMMARY"

      # Step 7: Compare runtime to baseline (or standard threshold)
      - name: Compare runtime to baseline (or standard threshold)
        shell: bash
        run: |
          set -e

          DURATION="${{ steps.etl_runtime.outputs.duration }}"

          # Defaults if baseline file is missing
          BASELINE=15
          MAX_PERCENT=30
          HARD_CAP=60

          BASELINE_FILE="enterprise-data-simulation/snowflake/perf/baseline.json"

          if [ -f "$BASELINE_FILE" ]; then
            BASELINE=$(node -p "require('./$BASELINE_FILE').etlRunSecondsBaseline")
            MAX_PERCENT=$(node -p "require('./$BASELINE_FILE').maxAllowedRegressionPercent")
            HARD_CAP=$(node -p "require('./$BASELINE_FILE').maxAllowedSecondsHardCap")
          fi

          ALLOWED=$(node -p "Math.ceil($BASELINE * (1 + $MAX_PERCENT / 100))")

          echo "Baseline: ${BASELINE}s" >> "$GITHUB_STEP_SUMMARY"
          echo "Allowed: ${ALLOWED}s" >> "$GITHUB_STEP_SUMMARY"
          echo "Hard cap: ${HARD_CAP}s" >> "$GITHUB_STEP_SUMMARY"
          echo "Actual: ${DURATION}s" >> "$GITHUB_STEP_SUMMARY"

          if [ "$DURATION" -gt "$HARD_CAP" ]; then
            echo "❌ ETL runtime exceeded hard cap (${HARD_CAP}s)." >&2
            exit 1
          fi

          if [ "$DURATION" -gt "$ALLOWED" ]; then
            echo "❌ ETL runtime regression detected." >&2
            exit 1
          fi

          echo "✅ Runtime within expected range." >> "$GITHUB_STEP_SUMMARY"

      # Step 8: Upload ETL artifacts for debugging
      - name: Upload ETL artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: etl-output
          path: enterprise-data-simulation/snowflake/data/*.json
